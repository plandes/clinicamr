# @meta {desc: 'application object config', date: '2024-01-11'}


## Overrides
#
# keep spaCy entity copy, but add MIMIC mask tokenization (comment out if
# non-MIMIC source)
amr_base_doc_parser:
  components: 'instance: list: mimic_component, mimic_tokenizer_component'
  token_decorators: 'instance: list: mimic_token_decorator'

# use the AMR base doc parser since it does not embed entities so token indexes
# are not perturbed by multi-word named entities
mednlp_combine_biomed_doc_parser:
  target_parser: 'instance: amr_base_doc_parser'
  yield_features: >-
    eval({'import': ['zensols.nlp as n', 'zensols.mednlp as m']}):
      list(m.MedicalFeatureToken.FEATURE_IDS |
      {'ent_', 'ent', 'ent_iob', 'ent_iob_', 'mimic_', 'onto_'})

# use scispacy NER model
mednlp_biomed_parser:
  model_name: en_ner_bionlp13cg_md

# medical section segmentation
mimicsid_section_predictor:
  section_filter_type: >-
    eval({'import': ['zensols.mimicsid as m']}):
      m.SectionFilterType.keep_non_empty

# remove newlines from sentences
camr_rm_space_decorator:
  class_name: zensols.nlp.decorate.FilterTokenSentenceDecorator
  remove_space: true

# recreate token index for mapping CUIs correctly
camr_reindex_decorator:
  class_name: zensols.nlp.decorate.UpdateDocumentDecorator
  update_indexes: false
  update_entity_spans: false
  reindex: true

# adds :cui-id CUI attributes
camr_token_cui_doc_decorator:
  class_name: zensols.clinicamr.decorator.ClinicTokenAnnotationFeatureDocumentDecorator
  use_sent_index: false
  role: :cui-id
  feature_id: cui_
  feature_format: '{cui_}'

# add :cui-desc CUI description attributes
camr_token_cui_desc_doc_decorator:
  class_name: ${camr_token_cui_doc_decorator:class_name}
  use_sent_index: ${camr_token_cui_doc_decorator:use_sent_index}
  role: :cui-desc
  feature_id: cui_
  feature_format: '{pref_name_}'

# the medical intermediate parser that strips space; otherwise alignments
# shifted from MIMIC-III newlines
camr_medical_doc_parser:
  class_name: zensols.nlp.parser.DecoratedFeatureDocumentParser
  delegate: 'instance: ${mednlp_default:doc_parser}'
  sentence_decorators: 'instance: tuple: camr_rm_space_decorator'
  document_decorators: 'instance: tuple: camr_reindex_decorator'

# use the medical parser when creating AmrFeatureDocument instances
amr_anon_doc_parser:
  delegate: 'instance: camr_medical_doc_parser'
  condition:
    if: 'eval: ${clinicamr_default:map_cuis}'
    then:
      document_decorators: >-
        instance: tuple:
          camr_token_cui_doc_decorator
#          camr_token_cui_desc_doc_decorator
#          amr_token_ent_doc_decorator
    else:
      document_decorators: []


## Section paragraph
#
amr_token_ent_doc_decorator:
  use_sent_index: false

camr_paragraph_stash:
  class_name: zensols.db.sqlite.SqliteDbStash
  path: 'path: ${mimic_default:shared_data_dir}/sec-para/${amr_default:amr_parser}-${amr_default:parse_model}.sqlite3'

camr_paragraph_factory:
  class_name: zensols.clinicamr.parafac.ClinicAmrParagraphFactory
  delegate: 'instance: mimic_chunker_paragraph_factory'
  amr_annotator: 'instance: ${amr_default:doc_parser}'
  stash: 'instance: camr_paragraph_stash'


## Application objects
#
# this parser is used to remove MIMIC masks as they result in ``<pointer:0>``
# type tokens from the SPRING parser
camr_fix_mimic_doc_parser:
  class_name: zensols.nlp.sparser.SpacyFeatureDocumentParser
  lang: en
  model_name: '${lang}_core_web_sm'
  components: 'instance: list: mimic_component, mimic_tokenizer_component'
  token_decorators: 'instance: list: mimic_token_decorator'

# spring AMR (THYME) parser
camr_parser_spring:
  class_name: zensols.clinicamr.spring.SpringAmrParser
  client: 'instance: amr_spring_client'
  doc_parser: 'instance: camr_fix_mimic_doc_parser'
